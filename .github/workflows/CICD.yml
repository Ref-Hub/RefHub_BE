name: Node.js CI/CD

on:
  push:
    branches: [ "develop", "main" ]

jobs:
  build:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: ğŸ“‚ ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: âš™ï¸ Node.js ${{ matrix.node-version }} ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm' # ì´ ìºì‹œëŠ” ëŸ¬ë„ˆì˜ ìºì‹œì´ë©°, ë¹Œë“œ ì†ë„ í–¥ìƒì— ë„ì›€ì„ ì¤ë‹ˆë‹¤.

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ (ëŸ¬ë„ˆ ì‘ì—… ê³µê°„ì— ì„¤ì¹˜)
        # ì´ ìŠ¤í…ì—ì„œ ëª¨ë“  ì˜ì¡´ì„±ì´ ëŸ¬ë„ˆì˜ ì„ì‹œ ë””ë ‰í† ë¦¬ì— ì„¤ì¹˜ë©ë‹ˆë‹¤.
        run: npm ci

      - name: âš™ï¸ í”„ë¡œì íŠ¸ ë¹Œë“œ
        run: npm run build --if-present

      - name: âœ… í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm test
          
      - name: ğŸš€ EC2ì— ë°°í¬
        run: |
          # EC2ì˜ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd ~/RefHub_BE
          
          # ğŸš¨ ì¤‘ìš”: ê¸°ì¡´ node_modules í´ë”ê°€ ìˆë‹¤ë©´ ë¨¼ì € ì‚­ì œí•˜ì—¬ ê³µê°„ì„ í™•ë³´í•˜ê³  ì¤‘ë³µ ì„¤ì¹˜ ë°©ì§€
          if [ -d "node_modules" ]; then
            echo "ê¸°ì¡´ ~/RefHub_BE/node_modules ì‚­ì œ ì¤‘..."
            rm -rf node_modules
          fi

          # ìµœì‹  ì½”ë“œ pull
          git pull --no-rebase origin ${{ github.ref_name }}

          # ğŸš¨ í•µì‹¬ ë³€ê²½: EC2 ì„œë²„ì—ì„œ npm installì„ ì œê±°í•˜ê³ , ëŒ€ì‹  ëŸ¬ë„ˆì—ì„œ ì„¤ì¹˜ëœ node_modulesë¥¼ ë³µì‚¬
          # ${{ github.workspace }}ëŠ” GitHub Actions ëŸ¬ë„ˆì˜ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ (ì¦‰, npm ciê°€ ì‹¤í–‰ëœ ê³³)
          echo "ëŸ¬ë„ˆì˜ node_modulesë¥¼ EC2 í”„ë¡œì íŠ¸ë¡œ ë³µì‚¬ ì¤‘..."
          cp -r ${{ github.workspace }}/node_modules . # í˜„ì¬ ë””ë ‰í† ë¦¬(~/RefHub_BE)ë¡œ ë³µì‚¬

          # PM2 ecosystem íŒŒì¼ ìƒì„± ë° PM2 ëª…ë ¹ ì‹¤í–‰ (ê¸°ì¡´ê³¼ ë™ì¼)
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "ìš´ì˜ìš© ecosystem.prod.config.cjs ìƒì„±"
            echo "module.exports = {
              apps: [{
                name: 'app-prod',
                script: 'app.js',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000,
                  MONGO_URI_PROD: '${{ secrets.MONGO_URI_PROD }}',
                  EMAIL_PASS: '${{ secrets.EMAIL_PASS }}',
                  EMAIL_USER: '${{ secrets.EMAIL_USER }}',
                  JWT_SECRET: '${{ secrets.JWT_SECRET }}',
                  JWT_REFRESH_SECRET: '${{ secrets.JWT_REFRESH_SECRET }}',
                  BASE_URL: '${{ secrets.BASE_URL }}',
                  S3_REGION: '${{ secrets.S3_REGION }}',
                  AWS_ACCESS_KEY_ID: '${{ secrets.AWS_ACCESS_KEY_ID }}',
                  AWS_SECRET_ACCESS_KEY: '${{ secrets.AWS_SECRET_ACCESS_KEY }}',
                  S3_BUCKET_NAME: '${{ secrets.S3_BUCKET_NAME }}',
                  S3_BASE_URL: '${{ secrets.S3_BASE_URL }}',
                  EXTENSION_ID: '${{ vars.EXTENSION_ID }}',
                  KAKAO_REST_API_KEY: '${{ secrets.KAKAO_REST_API_KEY }}',
                  KAKAO_REDIRECT_URI: '${{ secrets.KAKAO_REDIRECT_URI_PROD }}'
                }
              }]
            };" > ecosystem.prod.config.cjs
            pm2 start ecosystem.prod.config.cjs --only app-prod || pm2 restart app-prod
          else
            echo "ê°œë°œìš© ecosystem.dev.config.cjs ìƒì„±"
            echo "module.exports = {
              apps: [{
                name: 'app-dev',
                script: 'app.js',
                env: {
                  NODE_ENV: 'development',
                  PORT: 4000,
                  MONGO_URI_DEV: '${{ secrets.MONGO_URI_DEV }}',
                  EMAIL_PASS: '${{ secrets.EMAIL_PASS }}',
                  EMAIL_USER: '${{ secrets.EMAIL_USER }}',
                  JWT_SECRET: '${{ secrets.JWT_SECRET }}',
                  JWT_REFRESH_SECRET: '${{ secrets.JWT_REFRESH_SECRET }}',
                  BASE_URL: '${{ secrets.BASE_URL }}',
                  S3_REGION: '${{ secrets.S3_REGION }}',
                  AWS_ACCESS_KEY_ID: '${{ secrets.AWS_ACCESS_KEY_ID }}',
                  AWS_SECRET_ACCESS_KEY: '${{ secrets.AWS_SECRET_ACCESS_KEY }}',
                  S3_BUCKET_NAME: '${{ secrets.S3_BUCKET_NAME }}',
                  S3_BASE_URL: '${{ secrets.S3_BASE_URL }}',
                  EXTENSION_ID: '${{ vars.EXTENSION_ID }}',
                  KAKAO_REST_API_KEY: '${{ secrets.KAKAO_REST_API_KEY }}',
                  KAKAO_REDIRECT_URI: '${{ secrets.KAKAO_REDIRECT_URI_DEV }}'
                }
              }]
            };" > ecosystem.dev.config.cjs
            pm2 start ecosystem.dev.config.cjs --only app-dev || pm2 restart app-dev
          fi
        shell: bash

      - name: ğŸ—‘ï¸ ëŸ¬ë„ˆ ì‘ì—… ê³µê°„ ì •ë¦¬ (ë°°í¬ ì™„ë£Œ í›„)
        # ì´ ìŠ¤í…ì€ ë°°í¬ ì„±ê³µ/ì‹¤íŒ¨ì™€ ë¬´ê´€í•˜ê²Œ í•­ìƒ ì‹¤í–‰ë˜ì–´ ëŸ¬ë„ˆì˜ ì„ì‹œ ê³µê°„ì„ ë¹„ì›ë‹ˆë‹¤.
        if: always()
        run: |
          echo "ëŸ¬ë„ˆ ì‘ì—… ê³µê°„ì˜ node_modules ë° ìºì‹œ ì •ë¦¬ ì¤‘..."
          # ëŸ¬ë„ˆì˜ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬(ì—¬ê¸°ì„œëŠ” ~/actions-runner/_work/RefHub_BE/RefHub_BE/)ì— ìˆëŠ” node_modules ì‚­ì œ
          rm -rf ${{ github.workspace }}/node_modules
          # npm ìºì‹œë„ ì •ë¦¬í•˜ì—¬ í˜¹ì‹œ ëª¨ë¥¼ ê³µê°„ ë¶€ì¡±ì— ëŒ€ë¹„
          npm cache clean --force
        shell: bash
