name: Node.js CI/CD

on:
  push:
    branches: [ "develop", "main" ]

jobs:
  build:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: ðŸ“‚ ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: âš™ï¸ Node.js ${{ matrix.node-version }} ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: âš™ï¸ í”„ë¡œì íŠ¸ ë¹Œë“œ
        run: npm run build --if-present

      - name: âœ… í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm test
      
      - name: ðŸš€ EC2ì— ë°°í¬
        run: |
          cd ~/RefHub_BE
          git pull origin ${{ github.ref_name }}
          npm install
      
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "ìš´ì˜ìš© ecosystem.prod.config.cjs ìƒì„±"
            echo "module.exports = {
              apps: [{
                name: 'app-prod',
                script: 'app.js',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000,
                  MONGO_URI: '${{ secrets.MONGO_URI_PROD }}',
                  EMAIL_PASS: '${{ secrets.EMAIL_PASS }}',
                  EMAIL_USER: '${{ secrets.EMAIL_USER }}',
                  JWT_SECRET: '${{ secrets.JWT_SECRET }}',
                  JWT_REFRESH_SECRET: '${{ secrets.JWT_REFRESH_SECRET }}',
                  BASE_URL: '${{ secrets.BASE_URL }}',
                  S3_REGION: '${{ secrets.S3_REGION }}',
                  AWS_ACCESS_KEY_ID: '${{ secrets.AWS_ACCESS_KEY_ID }}',
                  AWS_SECRET_ACCESS_KEY: '${{ secrets.AWS_SECRET_ACCESS_KEY }}',
                  S3_BUCKET_NAME: '${{ secrets.S3_BUCKET_NAME }}',
                  S3_BASE_URL: '${{ secrets.S3_BASE_URL }}'
                }
              }]
            };" > ecosystem.prod.config.cjs
      
            pm2 start ecosystem.prod.config.cjs --only app-prod || pm2 restart app-prod
      
          else
            echo "ê°œë°œìš© ecosystem.dev.config.cjs ìƒì„±"
            echo "module.exports = {
              apps: [{
                name: 'app-dev',
                script: 'app.js',
                env: {
                  NODE_ENV: 'development',
                  PORT: 4000,
                  MONGO_URI: '${{ secrets.MONGO_URI_DEV }}',
                  EMAIL_PASS: '${{ secrets.EMAIL_PASS }}',
                  EMAIL_USER: '${{ secrets.EMAIL_USER }}',
                  JWT_SECRET: '${{ secrets.JWT_SECRET }}',
                  JWT_REFRESH_SECRET: '${{ secrets.JWT_REFRESH_SECRET }}',
                  BASE_URL: '${{ secrets.BASE_URL }}',
                  S3_REGION: '${{ secrets.S3_REGION }}',
                  AWS_ACCESS_KEY_ID: '${{ secrets.AWS_ACCESS_KEY_ID }}',
                  AWS_SECRET_ACCESS_KEY: '${{ secrets.AWS_SECRET_ACCESS_KEY }}',
                  S3_BUCKET_NAME: '${{ secrets.S3_BUCKET_NAME }}',
                  S3_BASE_URL: '${{ secrets.S3_BASE_URL }}'
                }
              }]
            };" > ecosystem.dev.config.cjs
      
            pm2 start ecosystem.dev.config.cjs --only app-dev || pm2 restart app-dev
          fi
        shell: bash
